# IHMC Java ROS2 Communication

ROS2 messaging for Java.

## Introduction

This library builds on [IHMC Pub Sub](https://github.com/ihmcrobotics/ihmc-pub-sub), an allocation free Java library for DDSI-RTPS messaging. It uses modified versions of [rosidl utilities](https://github.com/ros2/rosidl) to convert .msg files into Java types.

## Features

- Easy-to-use API for publishing and subscribing to ROS2 topics
- Allocation free modules for realtime support
- Carries documentation from *.msg files into Javadoc
- Gradle task for .msg -> .java generation
- Provided Java library for ROS [common_interfaces](https://github.com/ros2/common_interfaces), [rcl_interfaces](https://github.com/ros2/rcl_interfaces), and [geometry2](https://github.com/ros2/geometry2)

## Artifacts

```gradle
compile group: "us.ihmc", name: "ihmc-ros2-library", version: 0.7.0-alpha  // publish/subscribe API
compile group: "us.ihmc", name: "ros2-common-interfaces", version: 0.7.0-alpha  // ROS2 common message library
compile group: "us.ihmc", name: "ros2-msg-to-pubsub-generator", version: 0.7.0-alpha  // generator for .msg -> .java
```

## IHMC ROS2 Library

This library provides a minimal implementation of a Ros2Node in Java. Two versions are available:

- **Ros2Node**: Publishes in the same thread and uses direct callbacks for incoming messages.
- **RealtimeRos2Node**:	Stores outgoing and incoming messages in a queue and uses non-blocking calls to publish messages and allows polling for new messages.

### Non-realtime example

###### Publisher

```java
Ros2Node node = new Ros2Node(PubSubImplementation.FAST_RTPS, "Ros2ListenerExample");
Ros2Publisher<Int64> publisher = node.createPublisher(Int64.getPubSubType().get(), "/example");
Int64 message = new Int64();
for (int i = 0; i < 10; i++)
{
   message.setData(i);
   publisher.publish(message);
   Thread.sleep(1000);
}
```

###### Subscriber

```java
Ros2Node node = new Ros2Node(PubSubImplementation.FAST_RTPS, "Ros2ListenerExample");
node.createSubscription(Int64.getPubSubType().get(), subscriber -> {
   Int64 message = new Int64();
   try
   {
      if (subscriber.takeNextData(message, null))
      {
         System.out.println(message.getData());
      }
   }
   catch (IOException e)
   {
      // something bad happened
   }
}, "/example");

Thread.currentThread().join(); // keep thread alive to receive more messages
```

### Realtime example

###### Publish/Subscribe

```java
PeriodicThreadSchedulerFactory threadFactory = SystemUtils.IS_OS_LINUX ? // realtime threads only work on linux
      new PeriodicRealtimeThreadSchedulerFactory(20) :           // see https://github.com/ihmcrobotics/ihmc-realtime
      new PeriodicNonRealtimeThreadSchedulerFactory();                   // to setup realtime threads
RealtimeRos2Node node = new RealtimeRos2Node(PubSubImplementation.FAST_RTPS, threadFactory, "NonRealtimeRos2PublishSubscribeExample", "");
RealtimeRos2Publisher<Int64> publisher = node.createPublisher(Int64.getPubSubType().get(), "/example");
RealtimeRos2Subscription<Int64> subscription = node.createSubscription(Int64.getPubSubType().get(), "/example");

node.spin(); // start the realtime node thread

Int64 message = new Int64();
for (int i = 0; i < 10; i++)
{
   message.setData(i);
   publisher.publish(message);  // publish
}

Int64 incomingMessage = new Int64();
while (!subscription.poll(incomingMessage))
   ; // just waiting for the first message
System.out.println(incomingMessage); // first message
int i = 1;
while (i < 10)
{
   if (subscription.poll(incomingMessage))  // poll for new messages
   {
      System.out.println(incomingMessage);
      i++;
   }
   else
   {
      // no available messages
   }
}
```

## Note

The intermediate .idl files generated by this library are not valid to be used outside IHMC Pub/Sub. 

## License

Apache 2.0

## Maintainer Notes

### Generating Messages

`gradle generateMessages`

Refactor getSource() to getSourceAsStringBuilder()

### Publish

##### To maven local:

`gradle publishAll -PpublishUrl=local`

##### To IHMC Bintray Maven Release:

`gradle publishAll -PpublishUrl=ihmcRelease`
 